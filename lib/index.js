'use strict';var _regenerator=require('babel-runtime/regenerator'),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator'),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_crypto=require('crypto'),_path=require('path'),_fs=require('mz/fs'),_zlib=require('mz/zlib'),_mimeTypes=require('mime-types'),_compressible=require('compressible'),_compressible2=_interopRequireDefault(_compressible),_fsReaddirRecursive=require('fs-readdir-recursive'),_fsReaddirRecursive2=_interopRequireDefault(_fsReaddirRecursive),_koa=require('koa'),_zeelib=require('zeelib');Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var loadFile=function(a,b,c,d){var e=(0,_path.normalize)((0,_path.join)(c.prefix,a)),f=d[e]=d[e]?d[e]:{},g=f.path=(0,_path.join)(b,a),i=(0,_fs.statSync)(g),j=(0,_fs.readFileSync)(g);return f.cacheControl=c.cacheControl,f.maxAge=f.maxAge?f.maxAge:c.maxAge||0,f.type=f.mime=(0,_mimeTypes.lookup)(e)||'application/octet-stream',f.mtime=i.mtime,f.length=i.size,f.md5=(0,_crypto.createHash)('md5').update(j).digest('base64'),f.buffer=j,j=null,f},staticCache=function(a){var b=a.dir;a.prefix='/';var c={},d=!!a.gzip;return(0,_fsReaddirRecursive2.default)(b).forEach(function(e){loadFile(e,b,a,c)}),function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function f(g,i){var j,k,l,m,n,o,p,q,r;return _regenerator2.default.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if('HEAD'===g.method||'GET'===g.method){u.next=4;break}return u.next=3,i();case 3:return u.abrupt('return');case 4:if(0===g.path.indexOf(a.prefix)){u.next=8;break}return u.next=7,i();case 7:return u.abrupt('return');case 8:if(a.extraHeaders&&Array.isArray(a.extraHeaders)&&a.extraHeaders.length&&a.extraHeaders.forEach(function(v){for(var w in v)g.append(w,v[w])}),j=(0,_zeelib.safeDecodeURIComponent)((0,_path.normalize)(g.path)),k=c[j],k){u.next=44;break}if('.'!==(0,_path.basename)(j)[0]){u.next=16;break}return u.next=15,i();case 15:return u.abrupt('return');case 16:return l=void 0,u.prev=17,u.next=20,(0,_fs.statSync)((0,_path.normalize)((0,_path.join)(b,j+'/index.html'))).isFile();case 20:l=u.sent,u.next=25;break;case 23:u.prev=23,u.t0=u['catch'](17);case 25:return l&&(j+='/index.html'),j.charAt(0)===_path.sep&&(j=j.slice(1)),m=void 0,u.prev=28,u.next=31,(0,_fs.statSync)((0,_path.join)(b,j));case 31:m=u.sent,u.next=39;break;case 34:return u.prev=34,u.t1=u['catch'](28),u.next=38,i();case 38:return u.abrupt('return');case 39:if(m.isFile()){u.next=43;break}return u.next=42,i();case 42:return u.abrupt('return');case 43:k=loadFile(j,b,a,c);case 44:if(g.status=200,d&&g.vary('Accept-Encoding'),k.buffer){u.next=51;break}return u.next=49,(0,_fs.statSync)(k.path);case 49:n=u.sent,n.mtime>k.mtime&&(k.mtime=n.mtime,k.md5=null,k.length=n.size);case 51:if(g.response.lastModified=k.mtime,k.md5&&(g.response.etag=k.md5),!g.fresh){u.next=56;break}return g.status=304,u.abrupt('return');case 56:if(g.type=k.type,g.length=k.zipBuffer?k.zipBuffer.length:k.length,g.set('cache-control','public, max-age='+k.maxAge),k.md5&&g.set('content-md5',k.md5),'HEAD'!==g.method){u.next=62;break}return u.abrupt('return');case 62:if(o='gzip'===g.acceptsEncodings('gzip'),!k.zipBuffer){u.next=66;break}return o?(g.set('content-encoding','gzip'),g.body=k.zipBuffer):g.body=k.buffer,u.abrupt('return');case 66:if(p=d&&1024<k.length&&o&&(0,_compressible2.default)(k.type),!k.buffer){u.next=78;break}if(!p){u.next=76;break}return u.next=71,(0,_zlib.gzip)(k.buffer);case 71:k.zipBuffer=u.sent,g.set('content-encoding','gzip'),g.body=k.zipBuffer,u.next=77;break;case 76:g.body=k.buffer;case 77:return u.abrupt('return');case 78:q=(0,_fs.createReadStream)(k.path),k.md5||(r=(0,_crypto.createHash)('md5'),q.on('data',r.update.bind(r)),q.on('end',function(){k.md5=r.digest('base64')})),g.body=q,p&&(g.remove('content-length'),g.set('content-encoding','gzip'),g.body=q.pipe((0,_zlib.createGzip)()));case 82:case'end':return u.stop();}},f,void 0,[[17,23],[28,34]])}));return function(){return e.apply(this,arguments)}}()};exports.default=staticCache;
